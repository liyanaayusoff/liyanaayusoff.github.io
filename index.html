<!DOCTYPE html>
<html>
  <head>
    <title>TensorFlow.js - Face Mask Detection</title>
    <style>
      video {
        width: 640px;
        height: 480px;
      }
      canvas {
        position: absolute;
        top: 0;
        left: 0;
      }
      #frame {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 80px;
        font-weight: bold;
        color: white;
        text-shadow: 2px 2px black;
      }
    </style>
  </head>
  <body>
    <h1>Face Mask Detection using TensorFlow.js</h1>
    <video id="video" autoplay></video>
    <canvas id="canvas"></canvas>
    <div id="frame"></div>
    <div id="mask"></div>
    <div id="error-message" style="color: red;"></div>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.9.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/face-landmarks-detection@0.9.2"></script>
    <script>
      const video = document.getElementById('video');
      const canvas = document.getElementById('canvas');
      const maskSpan = document.getElementById('mask');
      const errorMessage = document.getElementById('error-message');
      const frame = document.getElementById('frame');
      const ctx = canvas.getContext('2d');
      let model;

      async function start() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: false, video: true });
          video.srcObject = stream;
        } catch (err) {
          errorMessage.innerText = 'Error: Webcam access denied.';
          return;
        }

        const facemesh = await tf.loadGraphModel('https://tfhub.dev/tensorflow/tfjs-model/face_landmark_68_tfjs/1/default/1');

        async function detectMask() {
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          const predictions = await facemesh.estimateFaces(video, false);

          if (predictions.length > 0) {
            const landmarks = predictions[0].scaledMesh;
            const topLip = landmarks.slice(48, 55);
            const bottomLip = landmarks.slice(55, 60);

            const topLipAvg = topLip.reduce((acc, curr) => acc + curr[1], 0) / topLip.length;
            const bottomLipAvg = bottomLip.reduce((acc, curr) => acc + curr[1], 0) / bottomLip.length;

            const distance = Math.abs(topLipAvg - bottomLipAvg);

            if (distance > 25) {
              maskSpan.innerText = 'No';
              frame.innerText = 'NO';
              frame.style.backgroundColor = 'red';
            } else {
              maskSpan.innerText = 'Yes';
              frame.innerText = 'YES';
              frame.style.backgroundColor = 'green';
            }
          } else {
            maskSpan.innerText = 'No';
            frame.innerText = 'NO';
            frame.style.backgroundColor = 'red';
          }

          requestAnimationFrame(detectMask);
        }

        detectMask();
      }

      start();
    </script>
  </body>
</html>
